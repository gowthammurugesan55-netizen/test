<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Room Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .veg-icon { border: 2px solid #15803d; padding: 2px; height: 14px; width: 14px; display: flex; align-items: center; justify-content: center; }
        .veg-circle { background: #15803d; border-radius: 50%; width: 6px; height: 6px; }
        .nonveg-icon { border: 2px solid #b91c1c; padding: 2px; height: 14px; width: 14px; display: flex; align-items: center; justify-content: center; }
        .nonveg-circle { background: #b91c1c; width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-bottom: 7px solid #b91c1c; }
        .sticky-header { position: sticky; top: 140px; z-index: 40; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <header class="p-6 bg-white shadow-sm sticky top-0 z-50">
        <div class="flex justify-between items-center mb-4">
            <h1 id="greeting" class="text-xl font-black text-orange-900 uppercase italic leading-tight">Hotel Cafe</h1>
            <span id="hours-display" class="text-[9px] bg-orange-800 text-white px-3 py-1 rounded-full font-bold">...</span>
        </div>
        <input type="text" id="search-input" oninput="renderMenu()" placeholder="Search menu..." class="w-full bg-gray-100 rounded-2xl py-3 px-5 text-sm outline-none">
        <div id="category-nav" class="flex gap-2 overflow-x-auto no-scrollbar mt-4 pb-2"></div>
    </header>

    <div class="px-4 mt-4 overflow-x-auto flex gap-4 no-scrollbar" id="banner-slider"></div>

    <main id="menu-container" class="p-4 pb-40 space-y-6"></main>

    <div id="bottom-bar" class="fixed bottom-0 inset-x-0 bg-white p-4 border-t shadow-2xl hidden z-50">
        <button onclick="toggleCart()" class="w-full bg-orange-900 text-white py-4 rounded-2xl font-bold flex justify-between px-6">
            <span>View Tray (<span id="cart-count">0</span>)</span>
            <span id="cart-total">$0.00</span>
        </button>
    </div>

    <div id="cart-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end">
        <div class="bg-white w-full max-h-[90vh] rounded-t-3xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Your Tray</h2>
                <button onclick="toggleCart()" class="text-2xl">&times;</button>
            </div>
            
            <div id="upsell-container" class="bg-orange-50 p-4 rounded-2xl mb-4">
                <p id="upsell-text" class="text-xs font-bold text-orange-800 mb-2 italic"></p>
                <div class="w-full bg-gray-200 h-1.5 rounded-full"><div id="upsell-bar" class="bg-orange-600 h-full transition-all duration-500"></div></div>
            </div>

            <div id="cart-items" class="space-y-4 mb-6"></div>
            <div id="upsell-suggestions" class="mb-6"></div>

            <div class="space-y-3 border-t pt-4">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="cust-name" placeholder="Name" class="p-3 bg-gray-50 rounded-xl text-sm">
                    <input type="tel" id="cust-phone" placeholder="Phone" class="p-3 bg-gray-50 rounded-xl text-sm">
                </div>
                <select id="delivery-schedule" class="w-full p-3 bg-gray-50 rounded-xl text-sm">
                    <option value="ASAP">Deliver ASAP</option>
                    <option value="Scheduled">Schedule for Later</option>
                </select>
                <div class="flex gap-4 text-sm p-2">
                    <label><input type="radio" name="payment" value="Room Charge" checked> Room Charge</label>
                    <label><input type="radio" name="payment" value="Cash"> Cash</label>
                </div>
                <textarea id="special-notes" placeholder="Any special requests?" class="w-full p-3 bg-gray-50 rounded-xl text-sm h-16"></textarea>
                <button onclick="sendOrder()" id="place-order-btn" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold">Confirm Order</button>
            </div>
        </div>
    </div>

    <script>
        let menu = {}; let cart = {};let banner = {};
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_YgOYiEthHx5Y4FVDbK5C_xEXe0mum_stCQ-T143tfhaLUwjJJ9U2gOdB3OpLsXva/exec";

        async function loadData() {
            const res = await fetch('menu.json');
            menu = await res.json();

            const specialsRes = await fetch('config.json');
            banner = await specialsRes.json();
            
            setDynamicGreeting(banner.config.hotelName);
            document.getElementById('hours-display').innerText = banner.config.serviceHours;
            
            renderBanners();
            renderCategoryNav();
            renderMenu();
        }

        function setDynamicGreeting(name) {
            const hr = new Date().getHours();
            let msg = hr < 12 ? "Good Morning" : hr < 17 ? "Good Afternoon" : "Good Evening";
            document.getElementById('greeting').innerHTML = `<span class="block text-[10px] font-normal opacity-60">${msg}</span>${name}`;
        }

        function renderBanners() {
            document.getElementById('banner-slider').innerHTML = banner.specials.map(s => `
                <div class="${s.bgColor} ${s.textColor} p-4 rounded-2xl min-w-[280px] text-sm font-bold shadow-sm">
                    ${s.text}
                </div>`).join('');
        }

        function renderCategoryNav() {
            const cats = Object.keys(menu).filter(c => !['config', 'specials', 'Upsell Items'].includes(c));
            document.getElementById('category-nav').innerHTML = cats.map(c => `
                <button onclick="document.getElementById('${c}').scrollIntoView({behavior:'smooth', block:'center'})" 
                class="whitespace-nowrap px-5 py-2 bg-white rounded-full text-[11px] font-bold shadow-sm border border-gray-100">
                    <i class="fa ${menu[c].icon} mr-1 text-orange-600"></i> ${c}
                </button>`).join('');
        }

        function renderMenu() {
            const container = document.getElementById('menu-container');
            const search = document.getElementById('search-input').value.toLowerCase();
            let html = '';

            for (const cat in menu) {
                if (['config', 'specials', 'Upsell Items'].includes(cat)) continue;
                const items = menu[cat].items.filter(i => i.name.toLowerCase().includes(search));
                if (items.length === 0) continue;

                html += `<div id="${cat}">
                    <div class="sticky-header bg-gray-50/90 backdrop-blur-md py-2 flex items-center gap-2">
                        <div class="bg-orange-900 text-white w-8 h-8 rounded-lg flex items-center justify-center text-xs">
                            <i class="fa ${menu[cat].icon}"></i>
                        </div>
                        <h2 class="font-black text-orange-900 uppercase tracking-widest text-sm">${cat}</h2>
                    </div>`;

                items.forEach(item => {
                    const qty = cart[item.id] ? cart[item.id].qty : 0;
                    const dietIcon = item.isVeg ? '<div class="veg-icon"><div class="veg-circle"></div></div>' : '<div class="nonveg-icon"><div class="nonveg-circle"></div></div>';
                    
                    html += `
                        <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center mb-3 border border-gray-50">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    ${dietIcon}
                                    <h3 class="font-bold text-gray-800 text-sm">${item.name}</h3>
                                </div>
                                <p class="text-orange-700 font-bold text-xs">$${item.price.toFixed(2)}</p>
                            </div>
                            
                            <div class="flex items-center">
                                ${qty > 0 ? `
                                    <div class="flex items-center gap-3 bg-orange-50 rounded-xl p-1 border border-orange-100">
                                        <button onclick="changeQty(${item.id}, -1, '${item.name}', ${item.price})" class="w-8 h-8 font-bold text-orange-900">-</button>
                                        <span class="text-sm font-black">${qty}</span>
                                        <button onclick="changeQty(${item.id}, 1, '${item.name}', ${item.price})" class="w-8 h-8 font-bold text-orange-900">+</button>
                                    </div>
                                ` : `
                                    <button onclick="changeQty(${item.id}, 1, '${item.name}', ${item.price})" class="bg-white border-2 border-orange-900 text-orange-900 px-6 py-2 rounded-xl font-bold text-xs">ADD</button>
                                `}
                            </div>
                        </div>`;
                });
                html += `</div>`;
            }
            container.innerHTML = html;
        }

        function changeQty(id, delta, name, price) {
            if (!cart[id]) cart[id] = { name, price, qty: 0 };
            cart[id].qty += delta;
            if (cart[id].qty <= 0) delete cart[id];
            
            updateUI();
            renderMenu(); // Refresh menu to update +/- buttons
        }

        function updateUI() {
            const count = Object.values(cart).reduce((a, b) => a + b.qty, 0);
            const total = Object.values(cart).reduce((a, b) => a + (b.qty * b.price), 0);
            
            document.getElementById('bottom-bar').classList.toggle('hidden', count === 0);
            document.getElementById('cart-count').innerText = count;
            document.getElementById('cart-total').innerText = `$${total.toFixed(2)}`;

            const limit = menu.config.upsellThreshold;
            document.getElementById('upsell-bar').style.width = Math.min((total/limit)*100, 100) + "%";
            document.getElementById('upsell-text').innerText = total < limit ? `Add $${(limit-total).toFixed(2)} for a free gift!` : "Gift Unlocked! ðŸŽ";

            renderCart();
            renderUpsellChoices();
        }

        function renderCart() {
            document.getElementById('cart-items').innerHTML = Object.entries(cart).map(([id, item]) => `
                <div class="flex justify-between items-center text-sm">
                    <span>${item.qty}x ${item.name}</span>
                    <span class="font-bold">$${(item.qty * item.price).toFixed(2)}</span>
                </div>`).join('');
        }

        function renderUpsellChoices() {
            const up = menu['Upsell Items'];
            document.getElementById('upsell-suggestions').innerHTML = `
                <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">Recommended Add-ons</p>
                <div class="flex gap-2 overflow-x-auto no-scrollbar">
                    ${up.map(i => `<div onclick="changeQty(${i.id}, 1, '${i.name}', ${i.price})" class="bg-gray-50 p-3 rounded-xl min-w-[100px] text-center border">
                        <p class="text-[10px] font-bold">${i.name}</p>
                        <p class="text-orange-700 font-bold text-[10px]">$${i.price.toFixed(2)}</p>
                    </div>`).join('')}
                </div>`;
        }

        function toggleCart() { document.getElementById('cart-modal').classList.toggle('hidden'); }

        async function sendOrder() {
            const name = document.getElementById('cust-name').value;
    const phone = document.getElementById('cust-phone').value;
    const notes = document.getElementById('special-notes').value || "None";
    const schedule = document.getElementById('delivery-schedule').value;
    const payment = document.querySelector('input[name="payment"]:checked').value;

    if (!name || !phone) return alert("Please provide your details");

    // 2. Guest Memory: Save details for next time
    localStorage.setItem('guestName', name);
    localStorage.setItem('guestPhone', phone);

    // 3. Construct Enhanced Message for Telegram
    let text = `ðŸ›Ž *NEW ORDER: ROOM ${roomNumber}*\n`;
    text += `ðŸ‘¤ *Guest:* ${name}\n`;
    text += `ðŸ“ž *Phone:* ${phone}\n`;
    text += `â° *Delivery:* ${schedule}\n`;
    text += `ðŸ’³ *Payment:* ${payment}\n`;
    text += `ðŸ“ *Notes:* ${notes}\n\n`;
    
    let total = 0;
    Object.values(cart).forEach(i => {
        text += `â€¢ ${i.qty}x ${i.name} (â‚¹${(i.qty * i.price).toFixed(2)})\n`;
        total += (i.qty * i.price);
    });
    text += `\nðŸ’° *Total: â‚¹${total.toFixed(2)}*`;

    // Send logic...
    const btn = document.getElementById('place-order-btn');
    btn.innerText = "Sending...";
    btn.disabled = true;

    try {
        await fetch(SCRIPT_URL, { method: "POST", mode: 'no-cors', body: JSON.stringify({ text: text }) });
         alert("Order Placed Successfully!");
        cart = {};
        updateBottomBar();
         location.reload();
    } catch (e) { 
        alert("Error."); 
        btn.disabled = false; 
    }
        }

        window.onload = loadData;
    </script>
</body>
</html>


